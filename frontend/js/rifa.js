import { mountHeader } from './header.js'; import { RafflesAPI } from './api.js'; import { BRL, getCart, saveCart, updateBadge } from './state.js'; mountHeader(); const id=new URLSearchParams(location.search).get('id'); const img=document.getElementById('raffle-img'); const titleEl=document.getElementById('raffle-title'); const descEl=document.getElementById('raffle-desc'); const priceEl=document.getElementById('raffle-price'); const dateEl=document.getElementById('raffle-date'); const qtyEl=document.getElementById('qty'); let raffle=null; async function load(){ try{ raffle=await RafflesAPI.byId(id); if(!raffle||raffle.error){titleEl.textContent='Rifa não encontrada';return} img.src=raffle.imagem||raffle.image||'img/icons/placeholder.svg'; img.alt=raffle.titulo||raffle.title; titleEl.textContent=raffle.titulo||raffle.title; descEl.textContent=raffle.descricao||raffle.description||''; priceEl.textContent=BRL(raffle.preco||raffle.price); dateEl.textContent=raffle.drawDate?new Date(raffle.drawDate).toLocaleDateString('pt-BR'):'—'; }catch(e){ titleEl.textContent='Erro ao carregar a rifa'; } } load(); document.getElementById('add').onclick=async()=>{ const qty=Math.max(1,+qtyEl.value||1); let numbers=[],reservationId=null,expiresAt=null; try{ const res=await RafflesAPI.reserve(id,qty,null); numbers=res?.numbers||[]; reservationId=res?.reservationId||null; expiresAt=res?.expiresAt||null; }catch(e){ for(let i=0;i<qty;i++) numbers.push(String(Math.floor(Math.random()*10000)).padStart(4,'0')); } const cart=getCart(); let item=cart.find(i=>i._id===id); const price=raffle?.preco||raffle?.price||0; if(item){ item.quantity+=qty; item.numbers.push(...numbers); } else { cart.push({_id:id,title:raffle.titulo||raffle.title,price,image:raffle.imagem||raffle.image,quantity:qty,numbers,reservationId,expiresAt}); } saveCart(cart); updateBadge(); location.href='carrinho.html'; };