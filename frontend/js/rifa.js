import { mountHeader } from './header.js'; import { RafflesAPI } from './api.js'; import { BRL, getCart, saveCart, updateBadge } from './state.js'; mountHeader();
const id=new URLSearchParams(location.search).get('id'); const img=document.getElementById('raffle-img'); const titleEl=document.getElementById('raffle-title'); const descEl=document.getElementById('raffle-desc'); const priceEl=document.getElementById('raffle-price'); const dateEl=document.getElementById('raffle-date'); const addBtn=document.getElementById('add'); let raffle=null;
async function load(){try{raffle=await RafflesAPI.byId(id); img.src=raffle.imagem||raffle.image||'img/icons/placeholder.svg'; titleEl.textContent=raffle.titulo||raffle.title; descEl.textContent=raffle.descricao||raffle.description||'Sem descrição.'; priceEl.textContent=BRL(raffle.preco||raffle.price); dateEl.textContent=raffle.dataSorteio||raffle.drawDate||'—';}catch(e){titleEl.textContent='Rifa não encontrada';}} load();
addBtn?.addEventListener('click',async ()=>{let numbers=[],reservationId=null,expiresAt=null; try{const res=await RafflesAPI.reserve(id,1,null); numbers=res?.numbers||[]; reservationId=res?.reservationId||null; expiresAt=res?.expiresAt||null;}catch{numbers=[String(Math.floor(Math.random()*10000)).padStart(4,'0')];} if(!raffle) return; const cart=getCart(); const f=cart.find(i=>i._id===id); if(f){f.quantity+=1; f.numbers.push(...numbers);} else{cart.push({_id:id,title:raffle.titulo||raffle.title,price:raffle.preco||raffle.price,image:raffle.imagem||raffle.image,quantity:1,numbers,reservationId,expiresAt});} saveCart(cart); updateBadge(); alert('Número reservado e adicionado ao carrinho!');});