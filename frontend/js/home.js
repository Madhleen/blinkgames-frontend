import { mountHeader } from './header.js'; import { RafflesAPI } from './api.js'; import { BRL, getCart, saveCart, updateBadge } from './state.js'; mountHeader();
const grid=document.getElementById('featured'); let cache=[]; async function load(){try{cache=await RafflesAPI.list(); grid.innerHTML=(cache||[]).slice(0,6).map(r=>`<article class="card"><img src="${r.imagem||r.image||'img/icons/placeholder.svg'}"><div class="body"><h3>${r.titulo||r.title}</h3><div class="price">R$ ${BRL(r.preco||r.price)}</div><div style="display:flex;gap:10px;margin-top:8px"><a class="btn" href="rifa.html?id=${r._id}">Ver</a><button class="btn btn-primary" data-id="${r._id}">Comprar agora</button></div></div></article>`).join('')||'<p>Nenhuma rifa ativa.</p>';}catch(e){grid.innerHTML='<p>Erro ao carregar rifas.</p>';}} load();
grid?.addEventListener('click',async e=>{const btn=e.target.closest('button[data-id]'); if(!btn) return; const id=btn.dataset.id; let numbers=[],reservationId=null,expiresAt=null; try{const res=await RafflesAPI.reserve(id,1,null); numbers=res?.numbers||[]; reservationId=res?.reservationId||null; expiresAt=res?.expiresAt||null;}catch{numbers=[String(Math.floor(Math.random()*10000)).padStart(4,'0')];} const r=(cache||[]).find(x=>String(x._id)===String(id)); if(!r) return; const cart=getCart(); const f=cart.find(i=>i._id===id); if(f){f.quantity+=1; f.numbers.push(...numbers);} else{cart.push({_id:id,title:r.titulo||r.title,price:r.preco||r.price,image:r.imagem||r.image,quantity:1,numbers,reservationId,expiresAt});} saveCart(cart); updateBadge(); alert('NÃºmero reservado e adicionado ao carrinho!');});